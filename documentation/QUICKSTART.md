#!/usr/bin/env bash
# Quick Start Guide for Metadata-Based LSTM SoH/RUL Models

# This script shows how to use the updated BMS models with metadata integration

set -e

echo "╔════════════════════════════════════════════════════════════════════════════════════════╗"
echo "║          SR-DUKF and LSTM SoC/SoH Estimation Models - QUICK START GUIDE              ║"
echo "╚════════════════════════════════════════════════════════════════════════════════════════╝"

echo ""
echo "All models now automatically load battery parameters from cleaned_dataset/metadata.csv"
echo "This enables per-file accuracy with automatic fallback to defaults."
echo ""

# ============================================================================
echo "1. QUICK TEST (Recommended to start)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Trains model on 50 files (2 epochs) and tests on 5 random files"
echo "   Takes ~3-5 minutes on CPU"
echo ""
echo "   \$ python3 scripts/test_metadata_based_model.py --quick"
echo ""
echo "   Output:"
echo "     • outputs/eda/test_hybrid_model.keras (trained model)"
echo "     • outputs/eda/test_predictions.csv (5 predictions with reference SoH)"
echo "     • outputs/eda/test_metadata_based_model_report.json (detailed metrics)"
echo ""

# ============================================================================
echo "2. MEDIUM TEST"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Trains on 150 files (5 epochs) and tests on 20 files"
echo "   Takes ~15-20 minutes on CPU"
echo ""
echo "   \$ python3 scripts/test_metadata_based_model.py --max-train 150 --num-test 20 --epochs 5"
echo ""

# ============================================================================
echo "3. FULL PRODUCTION TEST"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Trains on 500 files (10 epochs) and tests on 100 files"
echo "   Takes ~60-90 minutes on CPU"
echo ""
echo "   \$ python3 scripts/test_metadata_based_model.py \\"
echo "       --max-train 500 --num-test 100 --epochs 10"
echo ""

# ============================================================================
echo "4. SINGLE FILE INFERENCE"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Run inference on a single file with automatic metadata parameter loading"
echo "   Automatically loads C_nom from metadata for file"
echo ""
   \$ python3 scripts/infer_ukf.py --input cleaned_dataset/data/00001.csv
echo ""
echo "   Output:"
echo "     • Prediction summary (SoC, SoH, RUL, reference values)"
echo "     • outputs/eda/00001.ukf.inference.csv (with UKF_SoC and predictions)"
echo ""
echo "   With diagnostic output:"
echo ""
echo "   \$ python3 scripts/infer_hybrid.py \\"
echo "       --input cleaned_dataset/data/00001.csv --diagnostic"
echo ""
echo "   This also creates:"
echo "     • outputs/eda/00001.ekf_diag.csv (per-step EKF diagnostics)"
echo ""

# ============================================================================
echo "5. BATCH INFERENCE ON RANDOM FILES"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Test on 50 random files using existing model"
echo ""
echo "   \$ python3 scripts/test_metadata_based_model.py \\"
echo "       --skip-train --num-test 50 --model outputs/eda/hybrid_lstm_model.keras"
echo ""

# ============================================================================
echo "6. TRAIN INDIVIDUAL MODELS"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Train standalone LSTM SoH model (loads real data with metadata):"
echo ""
echo "   \$ python3 scripts/lstm_soh.py --max-files 100 --epochs 5"
echo ""
echo "   Output:"
echo "     • outputs/eda/lstm_soh_model.keras"
echo "     • outputs/eda/lstm_soh_stats.npz (normalization statistics)"
echo ""
echo ""
echo "   Train hybrid UKF+LSTM model (uses metadata for per-file parameters):"
echo ""
echo "   \$ python3 scripts/train_dekf_lstm.py --max-files 100 --epochs 10"
echo ""
echo "   Output:"
echo "     • outputs/eda/hybrid_lstm_model.keras (best model)"
echo "     • outputs/eda/hybrid_lstm_best.keras (checkpoint)"
echo "     • outputs/eda/hybrid_metrics.json"
echo ""

# ============================================================================
echo "7. KEY FEATURES"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Automatic Metadata Integration:"
echo "     • Per-file battery capacity (C_nom): 1.5-2.6 Ah"
echo "     • Series resistance (R0): from impedance tests"
echo "     • Charge transfer resistance (R_D): from impedance tests"
echo "     • Reference SoH/RUL: from capacity measurements"
echo ""
echo "   Graceful Fallback:"
echo "     • Uses defaults if metadata unavailable"
echo "     • No errors on missing impedance test data"
echo "     • CLI override always possible"
echo ""
echo "   Data Quality Checks:"
echo "     • Voltage range validation (2.5-4.3 V)"
echo "     • Current RMS checking"
echo "     • UKF saturation detection"
echo "     • Data quality warnings in output"
echo ""

# ============================================================================
echo "8. UNDERSTANDING TEST OUTPUT"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   From test_predictions.csv:"
echo ""
echo "   filename     : Test file name"
echo "   battery_id   : Battery identifier"
echo "   pred_soh     : Predicted SoH (0-1)"
echo "   ref_soh      : Reference SoH from metadata"
echo "   soh_error    : |pred_soh - ref_soh|"
echo "   pred_rul_scaled : Predicted RUL (scaled 0-1)"
echo "   ref_rul      : Reference RUL (cycles to SoH < 0.8)"
echo "   ukf_soc_final: Final UKF SoC estimate"
echo ""
echo "   From test_metadata_based_model_report.json:"
echo ""
echo "   soh_mae      : Mean Absolute Error for SoH predictions"
echo "   soh_rmse     : Root Mean Squared Error for SoH"
echo "   soh_std      : Standard deviation of errors"
echo "   soh_min/max_error : Error range"
echo ""

# ============================================================================
echo "9. PERFORMANCE EXPECTATIONS"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   With 50 training files (2 epochs):"
echo "     • SoH MAE: ~8-10%"
echo "     • Training loss: ~0.006"
echo "     • Validation loss: ~0.007"
echo ""
echo "   With 500 training files (20 epochs):"
echo "     • SoH MAE: ~3-5% (expected)"
echo "     • Training time: ~30 minutes"
echo ""

# ============================================================================
echo "10. ADVANCED OPTIONS"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Custom OCV fitting degree (affects accuracy):"
echo ""
   \$ python3 scripts/infer_ukf.py \
echo "       --input cleaned_dataset/data/00001.csv --ocv-degree 4"
echo ""
echo ""
echo "   Override UKF parameters via CLI:"
echo ""
echo "   \$ python3 scripts/infer_ukf.py \\"
echo "       --input cleaned_dataset/data/00001.csv \\"
echo "       --ukf-params '{\"C_nom\": 2.3, \"R0\": 0.055}'"
echo ""
echo ""
echo "   Initialize SoC from known value:"
echo ""
   \$ python3 scripts/infer_ukf.py \\
echo "       --input cleaned_dataset/data/00001.csv --init-soc 0.9"
echo ""

# ============================================================================
echo "11. FILE LOCATIONS"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   Metadata:"
echo "     • cleaned_dataset/metadata.csv (7,567 records)"
echo ""
echo "   Data:"
echo "     • cleaned_dataset/data/*.csv (2,769 discharge files)"
echo ""
echo "   Scripts:"
echo "     • scripts/train_dekf_lstm.py (Hybrid UKF+LSTM training)"
echo "     • scripts/infer_ukf.py (Inference with reference)"
echo "     • scripts/ukf_soc.py (UKF implementation)"
echo "     • scripts/dekf_soc.py (DEKF implementation)"
echo "     • scripts/test_metadata_based_model.py (Testing framework)"
echo "     • scripts/metadata_loader.py (Metadata utility)"
echo ""
echo "   Outputs:"
echo "     • outputs/eda/*.keras (model artifacts)"
echo "     • outputs/eda/*.json (metrics and reports)"
echo "     • outputs/eda/*.csv (predictions and diagnostics)"
echo ""

# ============================================================================
echo "12. DOCUMENTATION"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "   METADATA_INTEGRATION_COMPLETE.md         - Full implementation guide"
echo "   METADATA_BASED_EKF_PARAMETERS.md         - EKF parameter details"
echo "   SoC_SoH_RUL_CALCULATIONS.md              - Mathematical background"
echo "   SoC_SoH_RUL_QUICK_REFERENCE.md           - Parameter reference"
echo ""

echo ""
echo "╔════════════════════════════════════════════════════════════════════════════════════════╗"
echo "║                                                                                        ║"
echo "║                      READY TO START! Run the quick test:                             ║"
echo "║                                                                                        ║"
echo "║              python3 scripts/test_metadata_based_model.py --quick                    ║"
echo "║                                                                                        ║"
echo "╚════════════════════════════════════════════════════════════════════════════════════════╝"
echo ""
